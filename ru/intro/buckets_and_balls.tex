\chapter{Корзины и мячи}
\label{ch:BucketsAndBalls}

Связанные данные по-прежнему в значительной степени неизвестны или неправильно поняты и недооценены. Часто людям это кажется слишком сложным. 
Попробуем разобраться, начнем с переменных.

Что такое переменная в SPARQL? Просто то, что нужно чем-то заполнить. Но как вы можете представить себе это <<то>>? Это абстрактно. У нас нет способа постичь абстрактные вещи, если мы не ассоциируем их с чем-то физическим и конкретным. Трудно представить себе время, но как только мы рисуем его в пространстве, становится легче. Мы не можем представить мебель вообще, но представить стул может каждый.

Другая трудность заключается в том, чтобы сформулировать запрос на языке SPARQL. Хотя работа со SPARQL помогает понять, как работает граф знаний, запрос SPARQL на него не похож. Это как с символами в математике. <<5 не похоже на пять, в то время как ||||| равно пяти>>. Проблема со SPARQL аналогична:

\begin{quote}
Вы хотите запросить график знаний.\\
Вы хотите узнать что-то новое.\\
Но ваш запрос не похож на граф знаний.\\
Это похоже на линии струн.\\
\end{quote}

Итак, как решить проблему с определением переменной и формулировкой SPARQL-запроса?

Представим себе каждый SPARQL-запрос в виде графа связанных корзин и мячей.

Итак, переменные являются чем-то, что нужно заполнить, но абстрактными понятиями. Нам нужен физический контейнер, чтобы наполнить его вещами. Нам нужны корзины. И вещи похожие на мячи. Итак, давайте представим выполнение запроса, как заполнение корзин мячами.

Тогда процесс заполнения графа мячами будет выглядеть как на рис. ~\ref{fig:Query_as_filling_buckets_with_balls}.

\begin{marginfigure}[-1.5cm]
	{
		\setlength{\fboxsep}{0pt}%
		\setlength{\fboxrule}{1pt}%
		\fcolorbox{gray}{gray}{\includegraphics{./intro/bucketsAndBalls/Query_as_filling_buckets_with_balls.PNG}}
	}
    \caption{Образец графа заполнения корзин мячами.}
	\label{fig:Query_as_filling_buckets_with_balls}
\end{marginfigure}

Корзина \textbf{?A} должна быть заполнена теми мячами, которые имеют отношение \textbf{R} к мячу \textbf{B}.

Рисунок будет понятнее, если мы его упростим и нарисуем прямую линию (рис. ~\ref{fig:Graph_pattern_in_basket_and_balls_notation}). 

\begin{marginfigure}[1.0cm]
	{
		\setlength{\fboxsep}{0pt}%
		\setlength{\fboxrule}{1pt}%
		\fcolorbox{gray}{gray}{\includegraphics{./intro/bucketsAndBalls/Graph_pattern_in_basket_and_balls_notation.PNG}}
	}
    \caption{Шаблон графа в нотации <<Корзины и мячи>>.}
	\label{fig:Graph_pattern_in_basket_and_balls_notation}
\end{marginfigure}

Это шаблон графа в нотации <<Корзины и мячи>>. Направление отношения R не показано, но оно всегда слева направо.

Тогда процесс написания и выполнения SPARQL-запроса будет состоять из шагов:
\begin{enumerate}
    \item Выберите свои корзины (в них вы будете собирать нужные вам мячи).
    \item Составьте свои условия в виде графа корзин и мячей.
    \item Запустите свой запрос, чтобы наполнить ваши корзины мячами.
\end{enumerate}

Теперь напишем запрос, чтобы, например, получить всех глав правительств областей России, выполняя такие шаги:

\begin{enumerate}
    \item Возьмем две корзины, одна для регионов и одна для глав правительств.
    \item Корзину для регионов привяжем к мячу <<область России>> отношением <<экземпляр>> и она должна быть связана с корзиной <<главы правительства>>, которая, учитывая направление, следует рассматривать как <<имеет главу правительства>>, в нашем случае это будет губернатор или глава области
\end{enumerate}

Сделаем запрос более интересным и добавим еще одну корзину для фотографий губернаторов. Вот теперь запрос в нотации <<Корзины и мячи>> будет как на рис. ~\ref{fig:Query_in_basket_and_balls_notation}:

\begin{figure*}[h!]
    \includegraphics[width=0.7\linewidth]{./intro/bucketsAndBalls/Query_in_basket_and_balls_notation.PNG}
    \caption{Корзины и мячи для заполнения корзин <<глав правительства>> мячами <<областей России>> и <<фотографиями>>.}
	\label{fig:Query_in_basket_and_balls_notation}
\end{figure*}

\newpage
После выполнения запроса (рис. ~\ref{fig:Query_in_basket_and_balls_notation}) наши корзины будут выглядеть как на рис. ~\ref{fig:3_buckets_region_head_image}.

\begin{marginfigure}
	{
		\setlength{\fboxsep}{0pt}%
		\setlength{\fboxrule}{1pt}%
		\fcolorbox{gray}{gray}{\includegraphics{./intro/bucketsAndBalls/3_buckets_region_head_image.PNG}}
	}
    \caption{Корзины при выполнении запроса.}
	\label{fig:3_buckets_region_head_image}
\end{marginfigure}

Теперь перейдём к Викиданным и напишем этот запрос на языке SPARQL. Сначала выберем и назовём корзины для заполнения.

\begin{lstlisting}[ language=SPARQL ]
SELECT DISTINCT ?region ?head ?image
\end{lstlisting}

Далее напишем условия соответствия мячей корзинам. Все условия в SPARQL должны заключаться в фигурные скобки.

Когда нам нужно определённое отношение или мяч, нам нужно использовать его идентификатор. Викиданные облегчают поиск идентификатора и подсказывают его, когда Вы выбираете отношение (свойство) или мяч (элемент) по его метке. Чтобы указать отношения в графе знаний Викиданных мы используем префикс \textit{wdt:}, а для объектов (наших мячей) ~--- префикс \textit{wd:}.

Следуя нашему рис. ~\ref{fig:Query_in_basket_and_balls_notation}, напишем условия для заполнения первой корзины ?region, затем напишем первое отношение. Поскольку общей частью идентификаторов прямых отношений является wdt, мы пишем \textit{wdt}:, а затем нажимаем Ctrl+пробел, чтобы запустить службу подсказок или  автозаполнения Викиданных рис. ~\ref{fig:WDQS_popup_instance_of}.

\begin{marginfigure}[-2.5cm]
	{
		\setlength{\fboxsep}{0pt}%
		\setlength{\fboxrule}{1pt}%
		\fcolorbox{gray}{gray}{\includegraphics{./intro/bucketsAndBalls/WDQS_popup_instance_of.PNG}}
	}
    \caption{С помощью команды Ctrl+пробел открылось выпадающее контекстное меню автозаполнения свойства Викиданых.}
	\label{fig:WDQS_popup_instance_of}
\end{marginfigure}

После этого мы воспроизведем модель из рис. ~\ref{fig:Query_in_basket_and_balls_notation} в реальном запросе SPARQL.

Обычно при написании SPARQL-запроса его представляют в виде таблицы с тремя столбцами: субъект, предикат, объект или на языке викиданных ~--- объект, свойство, значение.

Но это укрепляет мышление. Поэтому, возможно, было бы лучше, чтобы хотя бы ваши первые запросы напоминали граф. Ставя корзину как субъект нового графа (тройной шаблон) под той же корзиной, которая является объектом предыдущего тройного шаблона, делает его более похожим на граф с рисунка корзины и шары ~\ref{fig:Query_in_basket_and_balls_notation}, который был представлен выше. Таким образом, наш запрос выглядит следующим образом:

\begin{lstlisting}[ language=SPARQL, caption={\href{https://w.wiki/4NVc}{Список ссылок глав областей России}\protect\footnotemark}, ]
SELECT DISTINCT ?region ?head ?image
{
    ?region wdt:P31 wd:Q835714; # oblast of Russia
    wdt:P6  ?head. # heads of government
    ?head  wdt:P18 ?image. # images of heads of government
}
\end{lstlisting}
\footnotetext{Получено 44 ссылки на области России и их глав правительства. Ссылка на SPARQL-запрос: \href{https://w.wiki/4NVc}{https://w.wiki/4NVc}}

\newpage Теперь посмотрите, как этот запрос выглядит в Викиданных, и запустите его. Затем нажмите на значок глаза слева и выберите \textit{``image grid``}, чтобы просмотреть результаты в виде сетки изображений (рис. ~\ref{fig:WDQS_drop_down_result_type}).

\begin{marginfigure}
	{
		\setlength{\fboxsep}{0pt}%
		\setlength{\fboxrule}{1pt}%
		\fcolorbox{gray}{gray}{\includegraphics[width=0.5\linewidth]{./intro/bucketsAndBalls/WDQS_drop_down_result_type.PNG}}
	}
    \caption{Выбор отображения результатов в виде \textit{``image grid``} (сетки изображений).}
	\label{fig:WDQS_drop_down_result_type}
\end{marginfigure}

Это неплохо для первого результата, но теперь на каждом изображении мы видим только идентификационные данные людей и идентификационные данные их страны. Если мы нажмем на идентификатор, мы получим много информации об этом предмете. Но было бы лучше, если бы, помимо идентификаторов, мы могли видеть их метки в результате запроса. Это похоже на наклеивание этикеток на наши корзины. 

\begin{figure*}[h!]
\includegraphics[width=0.6\linewidth]{./intro/bucketsAndBalls/Query_in_basket_and_balls_notation_with_ids.png}
\caption{Для объектов (корзин и мячей) и отношений узаканы идентификаторы.}
\label{fig:Query_in_basket_and_balls_notation_with_ids}
\end{figure*}

\textit{``label``} ~--- это метка, которая отображает название объекта (мяча), а не его идентификатор. Все, что вам нужно сделать, это: добавить слово \textit{``label``} к переменным и вызвать службу меток. Последнее вы делаете, снова нажимая Ctrl+пробел в новой строке внутри фигурных скобок, и тогда, начиная вводить <<метку>>, появляется служба маркировки. По умолчанию вы получаете подсказку с языком интерфейса и английским языком в качестве альтернативы, если метка недоступна на языке выбранного интерфейса Викиданных.

Викиданные полны таких замечательных сервисов, и для окончательного запроса мы воспользуемся еще одним. Чтобы получить результат в сетке изображений по умолчанию, поместите где-нибудь в своем запросе следующий комментарий: \textcolor{blue}{\#defaultView:ImageGrid}

На самом деле не все нужно писать вручную. Когда вы начнете печатать, сервис автозаполнения предложит варианты.

\newpage
Наш последний запрос выглядит так (листинг~\ref{lst:regionsOfHeads}). Запустите этот скрипт.

\begin{lstlisting}[ language=SPARQL, caption={\href{https://w.wiki/4ENR}{Список глав областей России}\protect\footnotemark}, label=lst:regionsOfHeads, ]
# List of regions of the Russia and images of heads of government
#defaultView:ImageGrid
SELECT DISTINCT ?region ?regionLabel ?head ?headLabel ?image
{
  ?region wdt:P31 wd:Q835714; # ?region is Oblast of Russia
          wdt:P6  ?head.      #         has head of government
  ?head  wdt:P18 ?image.      # head has image
  SERVICE wikibase:label {bd:serviceParam wikibase:language "ru"} 
}
\end{lstlisting}
\footnotetext{Получено 44 области России и их глав правительства. Ссылка на SPARQL-запрос: \href{https://w.wiki/4ENR}{https://w.wiki/4ENR}}

Такое представление о запросах SPARQL, как о связанных корзинах и мячах, может быть полезным, по крайней мере, в начале освоения Викиданных. И, конечно, у каждой метафоры есть свои ограничения. Например, нельзя поместить один и тот же мяч в две разные ностоящие корзины, но в эти виртуальные ~--- можно. <<Корзины и мячи>> могут быть полезны, чтобы вскарабкиваться на высоту абстракции Викиданных.